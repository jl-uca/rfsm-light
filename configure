#!/bin/bash

configure_options="$*"
platform=macos
dotprogram='dot'
dotviewer='graphviz'
qgv_dir=''
vcdviewer='gtkwave'
txtviewer='nano'
install_prefix='/usr/local/rfsm-light'
install_bindir=''
install_libdir=''
install_docdir=''
rfsmc='~/.opam/5.0.0/bin/rfsmc'
rfsmlib='~/.opam/5.0.0/share/rfsm/lib'
doc='yes'
sysc_dir='/usr/local/systemc-2.3.0'
local=''
qt_spec='macx-clang'
#qmake='/Developer/Qt5.8/5.8/clang_64/bin/qmake'
#qt_version='5.8.0'
#qt_config='x86_64'
qmake='/Users/jserot/Qt/6.3.1/macos/bin/qmake'
qt_version='6.3.1'
qt_config='arm64'

# Parse command-line arguments

while : ; do
  case "$1" in
    "") break;;
    -platform|--platform)
        platform=$2; shift;;
    -prefix|--prefix)
        install_prefix=$2; shift;;
    -bindir|--bindir)
        install_binbdir=$2; shift;;
    -libdir|--libdir)
        install_libdir=$2; shift;;
    -docdir|--docdir)
        install_docdir=$2; shift;;
#    -mandir|--mandir)
#        install_mandir=$2; shift;;
    -rfsmc|--rfsmc)
        rfsmc=$2; shift;;
    -rfsmlib|--rfsmlib)
        rfsmlib=$2; shift;;
    -no-doc|--no-doc)
        doc='';;
    -qmake|--make)
        qmake=$2; shift;;
    -qt_version|--qt_version)
        qt_version=$2; shift;;
    -qt_spec|--qt_spec)
        qt_spec=$2; shift;;
    -qt_config|--qt_config)
        qt_config=$2; shift;;
    -dot|--dot)
        dotprogram=$2; shift;;
    -dotviewer|--dotviewer)
        dotviewer=$2; shift;;
    -qgv|--qgv)
        qgv_dir=$2; shift;;
    -vcdviewer|--vcdviewer)
        vcdviewer=$2; shift;;
    -txtviewer|--txtviewer)
        txtviewer=$2; shift;;
    -help|--help)
        cat <<EOF
Usage: configure [options]
Options: [defaults in brackets after descriptions]
  --platform NAME         target platform (linux, macos or windows) [default: $platform]
  --prefix DIR            install executables, libs and docs in DIR [default: $prefix]
  --bindir DIR            install  executables in DIR [default: $install_bindir]
  --libdir DIR            install libraries in in DIR [default: $install_libdir]
  --docdir DIR            install documentation in DIR [default: $install_docdir]
  --rfsmc PATH            path to the rfsmc compiler [default: $rfsmc]
  --rfsmlib PATH          path to the rfsmc library [default: $rfsmlib]
  --no-doc                do not build the documentation from sources
  --qmake CMD             set qmake command [default: $qmake]
  --qt_version VERSION    set Qt version for building [default: $qt_version]
  --qt_spec NAME          set Qt spec for building [default: $qt_spec]
  --qt_config NAME        set Qt config for building [default: $qt_config]
  --dot NAME              command for runing dot program [default: $dotprogram]
  --dotviewer NAME        command for displaying .dot files [default: $dotviewer]
  --qgv DIR               enable use of the QGV library for DOT rendering, with the path to the source directory [default: not]
  --vcdviewer NAME        command for displaying .vcd files [default: $vcdviewer]
  --txtviewer NAME        command for displaying text files [default: $txtviewer]
  --help                  print this message
EOF
	exit 0;;
    *) echo "Unknown option \"$1\"." 1>&2; exit 2;;
  esac
  shift
done

if [ -n "$install_prefix" ]; then
  install_bindir="$install_prefix/bin"
  install_libdir="$install_prefix/lib"
  install_docdir="$install_prefix/doc"
fi

# Generate the config file

rootdir=`dirname $0`

cd $rootdir
rm -f config
touch config

# Write options

version=`cat VERSION`
echo "# generated by ./configure $configure_options" >> config
echo "" >> config
echo "RFSMC=$rfsmc" >> config
echo "RFSMLIB=$rfsmlib" >> config
echo "" >> config
echo "PLATFORM=$platform" >> config
echo "$version" >> config
echo "" >> config
echo "QMAKE=$qmake" >> config
echo "QT_VERSION=$qt_version" >> config
echo "QT_SPEC=$qt_spec" >> config
echo "QT_CONFIG=$qt_config" >> config
echo "" >> config
echo "BUILD_DOC=$doc" >> config
echo "" >> config
echo "# INSTALL PATHS" >> config
echo "INSTALL_BINDIR=$install_bindir" >> config
echo "INSTALL_LIBDIR=$install_libdir" >> config
if [ -n "$doc" ]; then
echo "INSTALL_DOCDIR=$install_docdir" >> config
fi

# Finish generated files

touch ./config-stamp

echo
echo "** Configuration summary **"
echo
echo "Directory where the distribution will be installed:"
echo "        binaries................   $install_bindir"
echo "        library.................   $install_libdir"
if [ -n "$doc" ]; then
echo "        documentation............. $install_docdir"
fi
echo

echo "** Wrote file ./config"

rm -f platform
touch platform

echo "# Platform-specific definitions to be used in automatically generated Makefiles" >> platform
echo "# Generated by ./configure $configure_options" >> platform
echo "# To be adjusted if necessary" >> platform
echo "" >> platform

pwd=`pwd`
if [ -n "$qgv_dir" ]; then
echo "USE_QGV=yes" >> platform
echo "QGVDIR=$qgv_dir" >> platform
else
echo "DOT=dot" >> platform
echo "DOTVIEWER=graphviz" >> platform
fi
echo "VCDVIEWER=gtkwave" >> platform
echo "TXTVIEWER=nano" >> platform
echo "" >> platform
echo "CXX=g++" >> platform
echo "LD=g++" >> platform
echo "CXXFLAGS=-Wall -Wno-deprecated -I." >> platform
echo "LDFLAGS=" >> platform

echo "** Wrote file ./platform"
echo "** Configuration completed successfully **"
